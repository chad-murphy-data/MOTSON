name: Run 100M Simulations

on:
  # Run every night at 6am UTC (after most matches finish)
  # The workflow is smart - it checks if new results exist and skips if nothing changed
  schedule:
    - cron: '0 6 * * *'   # Daily at 6am UTC

  # Manual trigger
  workflow_dispatch:
    inputs:
      skip_simulations:
        description: 'Skip simulations (just test deploy hook)'
        required: false
        default: false
        type: boolean

jobs:
  simulate:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check for new results
        id: check_results
        run: |
          CURRENT_WEEK=$(python -c "import sqlite3; conn = sqlite3.connect('data/motson.db'); c = conn.cursor(); c.execute('SELECT MAX(matchweek) FROM match_results'); print(c.fetchone()[0] or 0)")
          LAST_SIM_WEEK=$(python -c "import json; print(json.load(open('data/100m_simulation_results.json')).get('week', 0))" 2>/dev/null || echo "0")
          echo "Current matchweek: $CURRENT_WEEK"
          echo "Last simulation week: $LAST_SIM_WEEK"
          echo "current_week=$CURRENT_WEEK" >> $GITHUB_OUTPUT
          echo "last_sim_week=$LAST_SIM_WEEK" >> $GITHUB_OUTPUT
          if [ "$CURRENT_WEEK" -gt "$LAST_SIM_WEEK" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Run 100M simulations
        if: steps.check_results.outputs.should_run == 'true' && inputs.skip_simulations != true
        run: |
          echo "Starting 100M simulation run..."
          python scripts/run_100m_sims.py
          echo "Simulations complete!"

      - name: Update season_predictions table
        if: steps.check_results.outputs.should_run == 'true' && inputs.skip_simulations != true
        run: python scripts/sync_100m_to_db.py

      - name: Commit and push results
        if: steps.check_results.outputs.should_run == 'true' && inputs.skip_simulations != true
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/100m_simulation_results.json data/motson.db
          git diff --staged --quiet || git commit -m "Update 100M simulation results (Week ${{ steps.check_results.outputs.current_week }})"
          git push

      - name: Trigger Render deploy
        if: success()
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -n "$RENDER_DEPLOY_HOOK" ]; then
            echo "Triggering Render redeploy..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$RENDER_DEPLOY_HOOK")
            echo "Response code: $HTTP_CODE"
            if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
              echo "Render deploy triggered successfully!"
            else
              echo "Render deploy may have failed (HTTP $HTTP_CODE)"
            fi
          else
            echo "No RENDER_DEPLOY_HOOK secret set, skipping deploy trigger"
          fi

      - name: Summary
        run: |
          echo "## Simulation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Current week: ${{ steps.check_results.outputs.current_week }}" >> $GITHUB_STEP_SUMMARY
          echo "- Last sim week: ${{ steps.check_results.outputs.last_sim_week }}" >> $GITHUB_STEP_SUMMARY
          echo "- Should run: ${{ steps.check_results.outputs.should_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- Skip requested: ${{ inputs.skip_simulations }}" >> $GITHUB_STEP_SUMMARY
