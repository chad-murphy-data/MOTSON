name: Run 100M Simulations

on:
  # EPL typically plays:
  # - Saturday 3pm, 5:30pm (UK) -> runs Sunday 6am UTC
  # - Sunday 2pm, 4:30pm (UK) -> runs Monday 6am UTC
  # - Midweek Tue/Wed evenings -> runs Wed/Thu 6am UTC
  schedule:
    - cron: '0 6 * * 0'   # Sunday 6am UTC (after Saturday matches)
    - cron: '0 6 * * 1'   # Monday 6am UTC (after Sunday matches)
    - cron: '0 6 * * 3'   # Wednesday 6am UTC (after Tuesday midweek)
    - cron: '0 6 * * 4'   # Thursday 6am UTC (after Wednesday midweek)

  # Manual trigger
  workflow_dispatch:
    inputs:
      skip_simulations:
        description: 'Skip simulations (just test deploy hook)'
        required: false
        default: 'false'
        type: boolean

jobs:
  simulate:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hour timeout for safety

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check for new results
        id: check_results
        run: |
          # Get current week from database
          CURRENT_WEEK=$(python -c "
          import sqlite3
          conn = sqlite3.connect('data/motson.db')
          cursor = conn.cursor()
          cursor.execute('SELECT MAX(matchweek) FROM match_results')
          result = cursor.fetchone()[0]
          print(result or 0)
          ")

          # Get week from last simulation
          LAST_SIM_WEEK=$(python -c "
          import json
          try:
              with open('data/100m_simulation_results.json') as f:
                  print(json.load(f).get('week', 0))
          except:
              print(0)
          ")

          echo "Current matchweek: $CURRENT_WEEK"
          echo "Last simulation week: $LAST_SIM_WEEK"
          echo "current_week=$CURRENT_WEEK" >> $GITHUB_OUTPUT
          echo "last_sim_week=$LAST_SIM_WEEK" >> $GITHUB_OUTPUT

          if [ "$CURRENT_WEEK" -gt "$LAST_SIM_WEEK" ]; then
            echo "New results detected! Running simulations."
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "No new results. Skipping simulations."
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Run 100M simulations
        if: steps.check_results.outputs.should_run == 'true' && inputs.skip_simulations != 'true'
        run: |
          echo "Starting 100M simulation run..."
          python scripts/run_100m_sims.py
          echo "Simulations complete!"

      - name: Update season_predictions table
        if: steps.check_results.outputs.should_run == 'true' && inputs.skip_simulations != 'true'
        run: |
          echo "Syncing 100M data to database..."
          python -c "
import json
import sqlite3
from pathlib import Path

# Load 100M results
with open('data/100m_simulation_results.json') as f:
    data = json.load(f)

week = data['week']
teams = data['teams']

conn = sqlite3.connect('data/motson.db')
cursor = conn.cursor()

for team, stats in teams.items():
    cursor.execute('''
        INSERT OR REPLACE INTO season_predictions
        (team, week, expected_points, expected_position, title_prob, top4_prob,
         relegation_prob, position_probs, last_updated)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
    ''', (
        team,
        week,
        stats['expected_points'],
        stats['expected_position'],
        stats['p_title'] / 100,
        stats['p_top4'] / 100,
        stats['p_relegation'] / 100,
        '[]'
    ))

conn.commit()
conn.close()
print(f'Updated season_predictions for {len(teams)} teams at week {week}')
"

      - name: Commit and push results
        if: steps.check_results.outputs.should_run == 'true' && inputs.skip_simulations != 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/100m_simulation_results.json data/motson.db
          git diff --staged --quiet || git commit -m "Update 100M simulation results (Week $(python -c "import json; print(json.load(open('data/100m_simulation_results.json'))['week'])"))"
          git push

      - name: Trigger Render deploy
        if: success()
        run: |
          if [ -n "${{ secrets.RENDER_DEPLOY_HOOK }}" ]; then
            echo "Triggering Render redeploy..."
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')

            echo "Response code: $HTTP_CODE"
            echo "Response body: $BODY"

            if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
              echo "✅ Render deploy triggered successfully!"
            else
              echo "⚠️ Render deploy may have failed (HTTP $HTTP_CODE)"
            fi
          else
            echo "❌ No RENDER_DEPLOY_HOOK secret set, skipping deploy trigger"
          fi

      - name: Summary
        run: |
          echo "## Simulation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_results.outputs.should_run }}" == "true" ] && [ "${{ inputs.skip_simulations }}" != "true" ]; then
            echo "✅ **100M simulations completed for Week ${{ steps.check_results.outputs.current_week }}**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ inputs.skip_simulations }}" == "true" ]; then
            echo "⏭️ **Simulations skipped (test run)**" >> $GITHUB_STEP_SUMMARY
          else
            echo "⏭️ **No new results - simulations skipped**" >> $GITHUB_STEP_SUMMARY
            echo "Current week: ${{ steps.check_results.outputs.current_week }}" >> $GITHUB_STEP_SUMMARY
            echo "Last sim week: ${{ steps.check_results.outputs.last_sim_week }}" >> $GITHUB_STEP_SUMMARY
          fi
